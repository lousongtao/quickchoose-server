<!DOCTYPE html>

<!-- Auto Generated with Sencha Architect -->
<!-- Modifications to this file will be overwritten. -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>load picture --- example from internet able to view picture</title>
    <script src="extjs/ext-all-dev.js"></script>
    <script src="extjs/ext-theme-neptune.js"></script>
    <link rel="stylesheet" href="extjs/resources/ext-theme-neptune/ext-theme-neptune-all.css">
    <script type="text/javascript">
	//http://blog.csdn.net/yongh701/article/details/45390975
	//http://www.300166.net/web/extjs/50613915325850525432.html
	
	
	
	
	
		Ext.onReady(function(){
			var formpanel= Ext.create("Ext.form.FormPanel", {
    title: 'ExtJS 无刷新文件上传（<font color="red">文件最大</font>)',
    width: '1',
    height: '400',
    x:5,
    y: 5,
    layout: "form",
    bodyPadding: "5",
    defaultType: "textfield",
    fieldDefaults: { labelAlign: "left", labelWidth: 55 },
    items: [
        {
            id: 'File',
            name: 'File',
            inputType: "file",
            fieldLabel: '上传图片',
            xtype: 'textfield',
            anchor: '40%',
            allowBlank: false,
            listeners: {//监听事件
                'render': function () {//读取
                    console.log('读取照片');
                    var path = Ext.getCmp('File').getValue()
                    var url = 'file:///' + path;
                    console.log(url);//浏览器安全保护下的虚拟路径
                    Ext.getCmp('File').on('change', function (field, newValue, oldValue) {//上传图片的控件对象,刚刚选择的图片仿真路径，上次选择的图片仿真路径
                        console.log(newValue);
                        console.log('浏览器类型：是ie？' + Ext.isIE);
                        var show = Ext.getCmp('browseImage');
                        console.log(show);
                        if (Ext.isIE) {
                            
                        } else {//获取选择文件的路径信息？ 将路径绑定到显示图片的box内加载
                            var obj = Ext.getCmp('File').inputEl.dom.files;
                            console.log(len);
                            var len = obj.length;//选文件的数量
                            if (len < 1) {
                                console.log('没有选择图片');
                                return;
                            }

                            var imgurl = window.URL.createObjectURL(obj[0]);
                            console.log(imgurl)
                            Ext.getCmp('browseImage').getEl().dom.src = imgurl;

                        }
                    }, this);//这是选择文件 
                }
            }
        },
        {
            xtype: 'box', //或者xtype: 'component',
            width: 200, //图片宽度
            height: 200, //图片高度
            fieldLabel: "预览图片",
            id: 'browseImage',
            autoEl: {
                tag: 'img',    //指定为img标签
                //src: 'ftp://127.0.0.1/UserFile/UserData/20160320/hotel_hotel_20160820220330.jpg',  //Ext.BLANK_IMAGE_URL,//指定url路径
                src: Ext.BLANK_IMAGE_URL,
                id: 'imageBrowse'
            }
        }
    ],
    buttons: [
        {
            text: "上传",
            handler: function () {
                var formCmp = this.up("form");
                if (!formCmp.isValid()) return;    //验证未通过，返回
                var photoName = Ext.getCmp('File').getValue();
                console.log(photoName);
                formCmp.submit({
                    url: "menu/add_dish1",
                    method: "POST",
                    waitMsg: '正在上传...',
                    params: {
                        photoName: photoName
                    },
                    success: function (form, action,ret) {
                        console.log(form);
                        console.log(action);
                        console.log(ret);
                        Ext.MessageBox.alert("提示", action.result.message);
                    },
                    failure: function (form, action, ret) {
                        console.log('submit认为请求失败，可是操作成功了');
                        console.log(form);
                        console.log(action);
                        console.log(ret);
                        switch (action.failureType) {
                            case Ext.form.action.Action.CLIENT_INVALID:
                                Ext.Msg.alert('失败1', 'Form fields may not be submitted with invalid values');
                                break;
                            case Ext.form.action.Action.CONNECT_FAILURE:
                                Ext.Msg.alert('失败2', 'Ajax communication failed');
                                break;
                            case Ext.form.action.Action.SERVER_INVALID:
                                Ext.Msg.alert('失败3', action.result.message);
                        }
                    }
                });
            }
        }, {
            text: '关闭',
            handler: function () {
                //win.hide();
            }
        }
    ]
});
//窗体
var win = new Ext.Window({
    title: '上传文件窗口',
    width: 476,
    height: 374,
    resizable: false,
    modal: false,
    closable: false,
    closeAction: 'hide',
    custormServiceAimObjectId: '',//这是给哪个对象进行文件上传操作（如哪家酒店ID）
    custormFileType: ''//自定义属性，指向文件的类型
});
//html页面种通过调用这个函数显示上传窗体
function btnUpload_click(maxFileSize, winTitle, fileCategory, custormServiceAimObjectId) {//其他窗体需要进行上传文件只需要调用这个函数就可以
    console.log('调用js脚本的函数进行窗体');
    win.setTitle(winTitle);
    win.custormFileType = fileCategory;
    console.log(custormServiceAimObjectId);
    win.custormServiceAimObjectId = custormServiceAimObjectId;
    win.items.removeAll();//移除之前全部的items
    var limitFileMB = maxFileSize == null ? '10MB' : maxFileSize;
    formpanel.setTitle('ExtJS 无刷新文件上传（<font color="red">文件最大' + limitFileMB + '</font>)');
    win.items.add(formpanel);
    win.doLayout();
    win.show();
}
		
			var pall = Ext.create('Ext.panel.Panel',{
				width: 700,
				height: 500,
				padding: 10,
				
				items :[formpanel],
				renderTo: Ext.getBody()
			})
		});
		
		
	</script>
</head>
<body></body>
</html>